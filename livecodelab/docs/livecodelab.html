<!DOCTYPE html>  <html> <head>   <title>livecodelab.js</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               livecodelab.js             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>                            </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">drawLoopTimer</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">frame</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">doLNOnce</span> <span class="o">=</span> <span class="p">[];</span>
<span class="kd">var</span> <span class="nx">loopInterval</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">time</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">timeAtStart</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>animation loop</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">function</span> <span class="nx">animate</span><span class="p">()</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>loop on request animation loop
- it has to be at the begining of the function
- see details at http://my.opera.com/emoller/blog/2011/12/20/requestanimationframe-for-smart-er-animating
requestAnimationFrame seems to only do 60 fps, which in my case is too much,
I rather prefer to have a slower framerate but steadier.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">if</span> <span class="p">(</span><span class="nx">useRequestAnimationFrame</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">wantedFramesPerSecond</span> <span class="o">===</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">requestAnimationFrame</span><span class="p">(</span><span class="nx">animate</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>setTimeout("window.requestAnimationFrame(animate)",
      1000 / wantedFramesPerSecond);</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="p">(</span><span class="nx">loopInterval</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">loopInterval</span> <span class="o">=</span> <span class="nx">setInterval</span><span class="p">(</span><span class="s2">&quot;window.requestAnimationFrame(animate)&quot;</span><span class="p">,</span> <span class="mi">1000</span> <span class="o">/</span> <span class="nx">wantedFramesPerSecond</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nx">setTimeout</span><span class="p">(</span><span class="s1">&#39;animate();&#39;</span><span class="p">,</span> <span class="mi">1000</span> <span class="o">/</span> <span class="nx">wantedFramesPerSecond</span><span class="p">);</span>
  <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>clearDisplayList();</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">matrixStack</span> <span class="o">=</span> <span class="p">[];</span>
  <span class="nx">worldMatrix</span><span class="p">.</span><span class="nx">identity</span><span class="p">();</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>the sound list needs to be cleaned
and the beatsPerMinute set to zero
so that the user program can create its own from scratch</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">beatsPerMinute</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="nx">soundLoops</span><span class="p">.</span><span class="nx">soundIDs</span> <span class="o">=</span> <span class="p">[];</span>
  <span class="nx">soundLoops</span><span class="p">.</span><span class="nx">beatStrings</span> <span class="o">=</span> <span class="p">[];</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>rootObject = new THREE.Object3D();
scene.add(rootObject);
parentObject = rootObject;</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="nx">draw</span><span class="p">)</span> <span class="o">!=</span> <span class="s2">&quot;undefined&quot;</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">d</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">frame</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">timeAtStart</span> <span class="o">=</span> <span class="nx">d</span><span class="p">.</span><span class="nx">getTime</span><span class="p">();</span>
      <span class="nx">time</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nx">time</span> <span class="o">=</span> <span class="nx">d</span><span class="p">.</span><span class="nx">getTime</span><span class="p">()</span> <span class="o">-</span> <span class="nx">timeAtStart</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nx">doLNOnce</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="nx">fill</span><span class="p">(</span><span class="mh">0xFFFFFFFF</span><span class="p">);</span>
    <span class="nx">stroke</span><span class="p">(</span><span class="mh">0xFF000000</span><span class="p">);</span>
    <span class="nx">currentStrokeSize</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="nx">defaultNormalFill</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="nx">defaultNormalStroke</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="nx">ballDetLevel</span> <span class="o">=</span> <span class="nx">ballDefaultDetLevel</span><span class="p">;</span>
    <span class="nx">noLights</span><span class="p">();</span>
    <span class="nx">usedLines</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="nx">usedRectangles</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="nx">usedBoxes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="nx">usedAmbientLights</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="nx">usedPointLights</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>In theory there is no need to chuck away the
counter altogether, you could go through
the existing counters contained in this object
(one for each ball detail ever used)
and set it to zero. That would maybe save
some garbage collection time.
But it's probably not worth it...</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">usedSpheres</span> <span class="o">=</span> <span class="p">{};</span>
    <span class="nx">animationStyleValue</span> <span class="o">=</span> <span class="nx">normal</span><span class="p">;</span>
    <span class="nx">resetGradientStack</span><span class="p">();</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>bpm(0);</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">draw</span><span class="p">();</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>we have to repeat this check because in the case
the user has set frame = 0,
then we have to catch that case here
after the program has executed</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="nx">frame</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">timeAtStart</span> <span class="o">=</span> <span class="nx">d</span><span class="p">.</span><span class="nx">getTime</span><span class="p">();</span>
      <span class="nx">time</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nx">animationStyleUpdateIfChanged</span><span class="p">();</span>
    <span class="nx">simpleGradientUpdateIfChanged</span><span class="p">();</span>
    <span class="nx">updateBpmIfChanged</span><span class="p">();</span>
    <span class="nx">frame</span><span class="o">++</span><span class="p">;</span>
    <span class="nx">consecutiveFramesWithoutRunTimeError</span><span class="o">++</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">consecutiveFramesWithoutRunTimeError</span> <span class="o">==</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">lastStableProgram</span> <span class="o">=</span> <span class="nx">out</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>chromeHackUncaughtReferenceName = '';</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="p">}</span>
  <span class="p">}</span> <span class="c1">// if typeof draw</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>do the render</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">combDisplayList</span><span class="p">();</span>
  <span class="nx">render</span><span class="p">();</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>clearDisplayList();
update stats</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">stats</span><span class="p">.</span><span class="nx">update</span><span class="p">();</span>


  <span class="k">if</span> <span class="p">(</span><span class="nx">doLNOnce</span><span class="p">.</span><span class="nx">length</span> <span class="o">!==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>alert("a doOnce has been ran");</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">elaboratedSource</span> <span class="o">=</span> <span class="nx">editor</span><span class="p">.</span><span class="nx">getValue</span><span class="p">();</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">frenchVersion</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">elaboratedSource</span> <span class="o">=</span> <span class="nx">elaboratedSource</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/uneFois/g</span><span class="p">,</span> <span class="s2">&quot;doOnce&quot;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kd">var</span> <span class="nx">elaboratedSourceByLine</span> <span class="o">=</span> <span class="nx">elaboratedSource</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s2">&quot;\n&quot;</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>alert('splitting: ' + elaboratedSourceByLine.length );</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">iteratingOverSource</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">iteratingOverSource</span> <span class="o">&lt;</span> <span class="nx">doLNOnce</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">iteratingOverSource</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>alert('iterating: ' + iteratingOverSource );</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">elaboratedSourceByLine</span><span class="p">[</span><span class="nx">doLNOnce</span><span class="p">[</span><span class="nx">iteratingOverSource</span><span class="p">]]</span> <span class="o">=</span> <span class="nx">elaboratedSourceByLine</span><span class="p">[</span><span class="nx">doLNOnce</span><span class="p">[</span><span class="nx">iteratingOverSource</span><span class="p">]].</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/^(\s*)doOnce([ ]*\-&gt;[ ]*.+)$/gm</span><span class="p">,</span> <span class="s2">&quot;$1\u2713doOnce$2&quot;</span><span class="p">);</span>
      <span class="nx">elaboratedSourceByLine</span><span class="p">[</span><span class="nx">doLNOnce</span><span class="p">[</span><span class="nx">iteratingOverSource</span><span class="p">]]</span> <span class="o">=</span> <span class="nx">elaboratedSourceByLine</span><span class="p">[</span><span class="nx">doLNOnce</span><span class="p">[</span><span class="nx">iteratingOverSource</span><span class="p">]].</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/^(\s*)doOnce([ ]*\-&gt;[ ]*)$/gm</span><span class="p">,</span> <span class="s2">&quot;$1\u2713doOnce$2&quot;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="nx">elaboratedSource</span> <span class="o">=</span> <span class="nx">elaboratedSourceByLine</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot;\n&quot;</span><span class="p">);</span>

    <span class="kd">var</span> <span class="nx">cursorPositionBeforeAddingCheckMark</span> <span class="o">=</span> <span class="nx">editor</span><span class="p">.</span><span class="nx">getCursor</span><span class="p">();</span>
    <span class="nx">cursorPositionBeforeAddingCheckMark</span><span class="p">.</span><span class="nx">ch</span> <span class="o">=</span> <span class="nx">cursorPositionBeforeAddingCheckMark</span><span class="p">.</span><span class="nx">ch</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">frenchVersion</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">elaboratedSource</span> <span class="o">=</span> <span class="nx">elaboratedSource</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/doOnce/g</span><span class="p">,</span> <span class="s2">&quot;uneFois&quot;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nx">editor</span><span class="p">.</span><span class="nx">setValue</span><span class="p">(</span><span class="nx">elaboratedSource</span><span class="p">);</span>
    <span class="nx">editor</span><span class="p">.</span><span class="nx">setCursor</span><span class="p">(</span><span class="nx">cursorPositionBeforeAddingCheckMark</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>we want to avoid that another frame is run with the old
code, as this would mean that the
runOnce code is run more than once,
so we need to register the new code.
TODO: ideally we don't want to register the
new code by getting the code from codemirror again
because we don't know what that entails. We should
just pass the code we already have.
Also registerCode() may split the source code by line, so we can
avoid that since we've just split it, we could pass
the already split code.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">registerCode</span><span class="p">();</span>
  <span class="p">}</span>

<span class="p">}</span>

<span class="kd">var</span> <span class="nx">composer</span><span class="p">;</span>

<span class="kd">function</span> <span class="nx">render</span><span class="p">()</span> <span class="p">{</span>

  <span class="cm">/*</span>

<span class="cm">//DIVIDER</span>
<span class="cm">      var light = new THREE.PointLight( 0xFFFFFF );</span>
<span class="cm">      light.position.set( 10, 0, 10 );</span>
<span class="cm">      scene.add( light );</span>
<span class="cm">  */</span></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>need a light for the meshlambert material</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">if</span> <span class="p">(</span><span class="nx">isWebGLUsed</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">composer</span><span class="p">.</span><span class="nx">render</span><span class="p">();</span></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>//////////////////////</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>renderer.render(scene,camera);</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">renderer</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="nx">scene</span><span class="p">,</span> <span class="nx">camera</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p>the renderer draws into an offscreen canvas called sceneRenderingCanvas</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">finalRenderWithSceneAndBlendContext</span><span class="p">.</span><span class="nx">globalAlpha</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">;</span>
    <span class="nx">finalRenderWithSceneAndBlendContext</span><span class="p">.</span><span class="nx">clearRect</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">window</span><span class="p">.</span><span class="nx">innerWidth</span><span class="p">,</span> <span class="nb">window</span><span class="p">.</span><span class="nx">innerHeight</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <p>clear the final render context</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">finalRenderWithSceneAndBlendContext</span><span class="p">.</span><span class="nx">globalAlpha</span> <span class="o">=</span> <span class="nx">blendAmount</span><span class="p">;</span>
    <span class="nx">finalRenderWithSceneAndBlendContext</span><span class="p">.</span><span class="nx">drawImage</span><span class="p">(</span><span class="nx">previousRenderForBlending</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

    <span class="nx">finalRenderWithSceneAndBlendContext</span><span class="p">.</span><span class="nx">globalAlpha</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">;</span>
    <span class="nx">finalRenderWithSceneAndBlendContext</span><span class="p">.</span><span class="nx">drawImage</span><span class="p">(</span><span class="nx">sceneRenderingCanvas</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <p>draw the rendering of the scene on the final render
clear the final render context</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">previousRenderForBlendingContext</span><span class="p">.</span><span class="nx">globalCompositeOperation</span> <span class="o">=</span> <span class="s1">&#39;copy&#39;</span><span class="p">;</span>
    <span class="nx">previousRenderForBlendingContext</span><span class="p">.</span><span class="nx">drawImage</span><span class="p">(</span><span class="nx">finalRenderWithSceneAndBlend</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <p>previousRenderForBlendingContext.clearRect(0, 0, window.innerWidth,window.innerHeight)</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">sceneRenderingCanvasContext</span><span class="p">.</span><span class="nx">clearRect</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">window</span><span class="p">.</span><span class="nx">innerWidth</span><span class="p">,</span> <span class="nb">window</span><span class="p">.</span><span class="nx">innerHeight</span><span class="p">);</span>

  <span class="p">}</span>
<span class="p">}</span>


<span class="kd">var</span> <span class="nx">dimcodeOn</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>

<span class="kd">function</span> <span class="nx">triggerReset</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">pickRandomDefaultGradient</span><span class="p">();</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">autocodeOn</span><span class="p">)</span> <span class="nx">toggleAutocodeAndUpdateButtonAndBlinking</span><span class="p">();</span>
  <span class="nx">editor</span><span class="p">.</span><span class="nx">setValue</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">);</span>
  <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#resetButtonContainer&quot;</span><span class="p">).</span><span class="nx">css</span><span class="p">(</span><span class="s2">&quot;background-color&quot;</span><span class="p">,</span> <span class="s1">&#39;#FF0000&#39;</span><span class="p">);</span>
  <span class="nx">setTimeout</span><span class="p">(</span><span class="s1">&#39;$(&quot;#resetButtonContainer&quot;).css(&quot;background-color&quot;,&quot;&quot;);&#39;</span><span class="p">,</span> <span class="mi">200</span><span class="p">);</span>
<span class="p">}</span>


<span class="kd">var</span> <span class="nx">changesHappened</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>

<span class="kd">var</span> <span class="nx">cursorActivity</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>

<span class="kd">function</span> <span class="nx">selectTheme</span><span class="p">(</span><span class="nx">node</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">theme</span> <span class="o">=</span> <span class="nx">node</span><span class="p">.</span><span class="nx">options</span><span class="p">[</span><span class="nx">node</span><span class="p">.</span><span class="nx">selectedIndex</span><span class="p">].</span><span class="nx">innerHTML</span><span class="p">;</span>
  <span class="nx">editor</span><span class="p">.</span><span class="nx">setOption</span><span class="p">(</span><span class="s2">&quot;theme&quot;</span><span class="p">,</span> <span class="nx">theme</span><span class="p">);</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <p>clear the renderer's canvas to transparent black</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">function</span> <span class="nx">adjustCodeMirrorHeight</span><span class="p">()</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <p>resizing the text area is necessary otherwise
as the user types to the end of it, instead of just scrolling
the content leaving all the other parts of the page where
they are, it expands and it pushes down
the view of the page, meaning that the canvas goes up and
the menu disappears
so we have to resize it at launch and also every time the window
is resized.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;.CodeMirror-scroll&#39;</span><span class="p">).</span><span class="nx">css</span><span class="p">(</span><span class="s1">&#39;height&#39;</span><span class="p">,</span> <span class="nb">window</span><span class="p">.</span><span class="nx">innerHeight</span> <span class="o">-</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#theMenu&#39;</span><span class="p">).</span><span class="nx">height</span><span class="p">());</span>
<span class="p">}</span>


<span class="kd">function</span> <span class="nx">fullscreenify</span><span class="p">(</span><span class="nx">canvas</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">style</span> <span class="o">=</span> <span class="nx">canvas</span><span class="p">.</span><span class="nx">getAttribute</span><span class="p">(</span><span class="s1">&#39;style&#39;</span><span class="p">)</span> <span class="o">||</span> <span class="s1">&#39;&#39;</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-27">&#182;</a>               </div>               <p>alert("code height:" + $('#code').height());
alert("window height:" + window.innerHeight);
alert("code height:" + $('.CodeMirror-scroll').css('height'));
alert("menu height:" + $('#theMenu').height());</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nb">window</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;resize&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">adjustCodeMirrorHeight</span><span class="p">();</span>
    <span class="nx">resize</span><span class="p">(</span><span class="nx">canvas</span><span class="p">);</span>
  <span class="p">},</span> <span class="kc">false</span><span class="p">);</span>

  <span class="nx">resize</span><span class="p">(</span><span class="nx">canvas</span><span class="p">);</span>

  <span class="kd">function</span> <span class="nx">resize</span><span class="p">(</span><span class="nx">canvas</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">scale</span> <span class="o">=</span> <span class="p">{</span>
      <span class="nx">x</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
      <span class="nx">y</span><span class="o">:</span> <span class="mi">1</span>
    <span class="p">};</span>
    <span class="nx">scale</span><span class="p">.</span><span class="nx">x</span> <span class="o">=</span> <span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">innerWidth</span> <span class="o">+</span> <span class="mi">40</span><span class="p">)</span> <span class="o">/</span> <span class="nx">canvas</span><span class="p">.</span><span class="nx">width</span><span class="p">;</span>
    <span class="nx">scale</span><span class="p">.</span><span class="nx">y</span> <span class="o">=</span> <span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">innerHeight</span> <span class="o">+</span> <span class="mi">40</span><span class="p">)</span> <span class="o">/</span> <span class="nx">canvas</span><span class="p">.</span><span class="nx">height</span><span class="p">;</span>

    <span class="nx">scale</span> <span class="o">=</span> <span class="nx">scale</span><span class="p">.</span><span class="nx">x</span> <span class="o">+</span> <span class="s1">&#39;, &#39;</span> <span class="o">+</span> <span class="nx">scale</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-28">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-28">&#182;</a>               </div>               <p>alert('style: ' +  style);</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="cm">/*</span>
<span class="cm">        if (scale.x &lt; 1 || scale.y &lt; 1) {</span>
<span class="cm">            scale = &#39;1, 1&#39;;</span>
<span class="cm">        } else if (scale.x &lt; scale.y) {</span>
<span class="cm">            scale = scale.x + &#39;, &#39; + scale.x;</span>
<span class="cm">        } else {</span>
<span class="cm">            scale = scale.y + &#39;, &#39; + scale.y;</span>
<span class="cm">        }</span>
<span class="cm">        */</span>

    <span class="nx">canvas</span><span class="p">.</span><span class="nx">setAttribute</span><span class="p">(</span><span class="s1">&#39;style&#39;</span><span class="p">,</span> <span class="nx">style</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="s1">&#39;-ms-transform-origin: left top; -webkit-transform-origin: left top; -moz-transform-origin: left top; -o-transform-origin: left top; transform-origin: left top; -ms-transform: scale(&#39;</span> <span class="o">+</span> <span class="nx">scale</span> <span class="o">+</span> <span class="s1">&#39;); -webkit-transform: scale3d(&#39;</span> <span class="o">+</span> <span class="nx">scale</span> <span class="o">+</span> <span class="s1">&#39;, 1); -moz-transform: scale(&#39;</span> <span class="o">+</span> <span class="nx">scale</span> <span class="o">+</span> <span class="s1">&#39;); -o-transform: scale(&#39;</span> <span class="o">+</span> <span class="nx">scale</span> <span class="o">+</span> <span class="s1">&#39;); transform: scale(&#39;</span> <span class="o">+</span> <span class="nx">scale</span> <span class="o">+</span> <span class="s1">&#39;);&#39;</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-29">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-29">&#182;</a>               </div>               <p>this code below is if one wants to keep the aspect ratio
but I mean one doesn't necessarily resize the window
keeping the same aspect ratio.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="p">}</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-30">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-30">&#182;</a>               </div>               <p>TODO In theory we want to re-draw the background because the
aspect ration might have changed.
But for the time being we only have vertical
gradients so that's not going to be a problem.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">function</span> <span class="nx">combDisplayList</span><span class="p">()</span> <span class="p">{</span>

  <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">scene</span><span class="p">.</span><span class="nx">objects</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">sceneObject</span> <span class="o">=</span> <span class="nx">scene</span><span class="p">.</span><span class="nx">objects</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">sceneObject</span><span class="p">.</span><span class="nx">isLine</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">usedLines</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">sceneObject</span><span class="p">.</span><span class="nx">visible</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
        <span class="nx">usedLines</span><span class="o">--</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">sceneObject</span><span class="p">.</span><span class="nx">visible</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">sceneObject</span><span class="p">.</span><span class="nx">isRectangle</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">usedRectangles</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">sceneObject</span><span class="p">.</span><span class="nx">visible</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
        <span class="nx">usedRectangles</span><span class="o">--</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">sceneObject</span><span class="p">.</span><span class="nx">visible</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">sceneObject</span><span class="p">.</span><span class="nx">isBox</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">usedBoxes</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">sceneObject</span><span class="p">.</span><span class="nx">visible</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
        <span class="nx">usedBoxes</span><span class="o">--</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">sceneObject</span><span class="p">.</span><span class="nx">visible</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">sceneObject</span><span class="p">.</span><span class="nx">isCylinder</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">usedCylinders</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">sceneObject</span><span class="p">.</span><span class="nx">visible</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
        <span class="nx">usedCylinders</span><span class="o">--</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">sceneObject</span><span class="p">.</span><span class="nx">visible</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">sceneObject</span><span class="p">.</span><span class="nx">isAmbientLight</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">usedAmbientLights</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">sceneObject</span><span class="p">.</span><span class="nx">visible</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
        <span class="nx">usedAmbientLights</span><span class="o">--</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">sceneObject</span><span class="p">.</span><span class="nx">visible</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">sceneObject</span><span class="p">.</span><span class="nx">isSphere</span> <span class="o">!==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">usedSpheres</span><span class="p">[</span><span class="s1">&#39;&#39;</span> <span class="o">+</span> <span class="nx">sceneObject</span><span class="p">.</span><span class="nx">isSphere</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">sceneObject</span><span class="p">.</span><span class="nx">visible</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
        <span class="nx">usedSpheres</span><span class="p">[</span><span class="s1">&#39;&#39;</span> <span class="o">+</span> <span class="nx">sceneObject</span><span class="p">.</span><span class="nx">isSphere</span><span class="p">]</span> <span class="o">=</span> <span class="nx">usedSpheres</span><span class="p">[</span><span class="s1">&#39;&#39;</span> <span class="o">+</span> <span class="nx">sceneObject</span><span class="p">.</span><span class="nx">isSphere</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">sceneObject</span><span class="p">.</span><span class="nx">visible</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>


<span class="kd">function</span> <span class="nx">clearDisplayList</span><span class="p">()</span> <span class="p">{</span>
  <span class="cm">/*</span>
<span class="cm">  for(var i = 0; i &lt; scene.objects.length; ++i) {</span>
<span class="cm">      scene.remove(scene.objects[i]);</span>
<span class="cm">      i--;</span>
<span class="cm">  }</span>
<span class="cm">  */</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-31">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-31">&#182;</a>               </div>               <p>By doing some profiling it is apparent that
adding and removing objects has a big cost.
So instead of adding/removing objects every frame,
objects are only added at creation and they are
never removed from the scene. They are
only made invisible. This routine combs the
scene and finds the objects that.
TODO a way to shrink the scene if it's been a
long time that only a handful of lines/meshes
have been used.</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-32">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-32">&#182;</a>               </div>               <p>var chromeHackUncaughtReferenceName = '';
var chromeHackUncaughtReferenceNames = [];</p>             </td>             <td class="code">               <div class="highlight"><pre> <span class="kd">var</span> <span class="nx">foo</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">msg</span><span class="p">,</span> <span class="nx">url</span><span class="p">,</span> <span class="nx">linenumber</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-33">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-33">&#182;</a>               </div>               <p>swap the two lines below in case one needs to
debug the environment, otherwise all errors are
caught and not bubbled up to the browser debugging tool.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">if</span> <span class="p">(</span><span class="nx">autocodeOn</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">editor</span><span class="p">.</span><span class="nx">undo</span><span class="p">();</span></pre></div>             </td>           </tr>                               <tr id="section-34">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-34">&#182;</a>               </div>               <p>window.onerror = function(msg, url, linenumber) {</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s2">&quot;Uncaught ReferenceError: &quot;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">msg</span> <span class="o">=</span> <span class="nx">msg</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">25</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#dangerSignText&#39;</span><span class="p">).</span><span class="nx">css</span><span class="p">(</span><span class="s1">&#39;color&#39;</span><span class="p">,</span> <span class="s1">&#39;red&#39;</span><span class="p">);</span>
  <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#errorMessageText&#39;</span><span class="p">).</span><span class="nx">text</span><span class="p">(</span><span class="nx">msg</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-35">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-35">&#182;</a>               </div>               <p>alert("did an undo");</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="cm">/*</span>
<span class="cm"> if (msg.indexOf(&quot;Uncaught ReferenceError&quot;) &gt; -1) {</span>
<span class="cm">  chromeHackUncaughtReferenceName = msg.split(&#39; &#39;)[2];</span>

<span class="cm">  var lengthToCheck = chromeHackUncaughtReferenceNames.length;</span>
<span class="cm">  if (lengthToCheck == 0){</span>
<span class="cm">    chromeHackUncaughtReferenceNames.push(chromeHackUncaughtReferenceName);</span>
<span class="cm">  }</span>
<span class="cm">  else {</span>
<span class="cm">    for (var iteratingOverSource = 0; iteratingOverSource &lt; lengthToCheck; iteratingOverSource++) {</span>
<span class="cm">      if (chromeHackUncaughtReferenceNames[iteratingOverSource].indexOf(chromeHackUncaughtReferenceName) &gt; -1) {</span>
<span class="cm">        break;</span>
<span class="cm">      }</span>
<span class="cm">      else if (iteratingOverSource == lengthToCheck-1) {</span>

<span class="cm">//DIVIDER</span>
<span class="cm">       chromeHackUncaughtReferenceNames.push(chromeHackUncaughtReferenceName);</span>
<span class="cm">      }</span>
<span class="cm">    }</span>
<span class="cm">  }</span>
<span class="cm"> }</span>
<span class="cm"> */</span></pre></div>             </td>           </tr>                               <tr id="section-36">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-36">&#182;</a>               </div>               <p>ok so this is kind of a hack that we need to put
in place for Chrome (both Windows and Mac)
what Chrome does is: when there is a function call,
it evaluates the arguments
of a function even if the function is undefined
so for example
doO alert "miao"
alerts a miao, because it's translated into
doO(alert("miao))
and even if doO is undefined, the argumen is evaluated
This is a problem because doOnce would encourage
the following use: misspell doOnce until the rest of the
line is finished, then correct the mispell to actually
run the line once.
But unfortunately because of the quirk described above,
that wouldn't work in Chrome.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">consecutiveFramesWithoutRunTimeError</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
  <span class="nb">window</span><span class="p">.</span><span class="nb">eval</span><span class="p">(</span><span class="nx">lastStableProgram</span><span class="p">);</span>

  <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
<span class="p">}</span>

</pre></div>             </td>           </tr>                               <tr id="section-37">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-37">&#182;</a>               </div>               <p>if we are here it means that the variable is not in the array</p>             </td>             <td class="code">               <div class="highlight"><pre>undefined</pre></div>             </td>           </tr>                               <tr id="section-38">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-38">&#182;</a>               </div>               <p>we set this to 6 because we save it as stable
when it's 5, so we avoid re-saving.</p>             </td>             <td class="code">               <div class="highlight"><pre>undefined</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 